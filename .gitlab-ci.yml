# GitLab CI/CD Pipeline for Astro + Sanity Website
# Optimized for auxodata.com deployment

stages:
  - security
  - test
  - build
  - deploy
  - performance

variables:
  NODE_VERSION: "20.19.0"
  NPM_VERSION: "10.2.3"
  GIT_DEPTH: 10
  FF_USE_FASTZIP: "true"
  FF_DISABLE_UMASK_FOR_DOCKER_EXECUTOR: "true"

# Global cache configuration
cache:
  key:
    files:
      - package-lock.json
  paths:
    - .npm/
    - node_modules/
    - dist/
  policy: pull-push

# Security scanning
secret_detection:
  stage: security
  image: zricethezav/gitleaks:latest
  script:
    - gitleaks detect --verbose --redact --config .gitleaks.toml || true
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

# Dependency vulnerability scanning
dependency_scanning:
  stage: security
  image: node:${NODE_VERSION}
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - npm audit --audit-level high --production || true
    - npx audit-ci --config audit-ci.json || true
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop
  artifacts:
    when: always
    expire_in: 1 week

# License compliance scanning
license_scanning:
  stage: security
  image: node:${NODE_VERSION}
  before_script:
    - npm ci --cache .npm --prefer-offline
    - npm install --save-dev license-checker || true
  script:
    - npx license-checker --production --csv > licenses.csv || echo "license-checker not available"
    - npx license-checker --production --summary | tee license-summary.txt || echo "license-checker not available"
  artifacts:
    paths:
      - licenses.csv
      - license-summary.txt
    expire_in: 1 week
    when: always
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

# Linting and type checking
lint:
  stage: test
  image: node:${NODE_VERSION}
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - npm run lint
  artifacts:
    when: always
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop
  allow_failure: true

# Unit tests and integration tests
test:
  stage: test
  image: mcr.microsoft.com/playwright:v1.57.0-jammy
  before_script:
    - npm ci --cache .npm --prefer-offline
    - npx playwright install --with-deps
  script:
    - npm run test:ci
  artifacts:
    paths:
      - test-results/
      - playwright-report/
    reports:
      junit: test-results/junit.xml
    expire_in: 1 week
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'
  only:
    - merge_requests
    - main
    - develop
  allow_failure: true

# Build production assets
build:
  stage: build
  image: node:${NODE_VERSION}
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour
  only:
    - main
    - develop
    - merge_requests
  environment:
    name: production
    url: https://auxodata.com

# Deploy to GitLab Pages (only on main branch)
pages:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Deploying to GitLab Pages for auxodata.com..."
    - cp -r dist public
    - ls -la public/
  artifacts:
    paths:
      - public/
    expire_in: 1 year
  only:
    - main
  needs:
    - build

# Performance monitoring with Lighthouse
performance:
  stage: performance
  image: node:${NODE_VERSION}
  before_script:
    - npm ci --cache .npm --prefer-offline
    - npm install --save-dev @lhci/cli || true
  script:
    - npx lhci autorun --config=lighthouserc.json || echo "Lighthouse CI not available"
  artifacts:
    paths:
      - .lighthouseci/
    expire_in: 1 week
    when: always
  only:
    - main
    - merge_requests
  needs:
    - build
  allow_failure: true

# Accessibility testing
accessibility:
  stage: performance
  image: node:${NODE_VERSION}
  before_script:
    - npm ci --cache .npm --prefer-offline
    - npm install --save-dev pa11y-ci || true
  script:
    - npx pa11y-ci --config=.pa11yci.json || echo "Pa11y CI not available"
  artifacts:
    paths:
      - accessibility-results.json
    expire_in: 1 week
    when: always
  only:
    - main
    - merge_requests
  needs:
    - build
  allow_failure: true

# Bundle size monitoring
bundle_size:
  stage: performance
  image: node:${NODE_VERSION}
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - npm run bundlesize || echo "Bundle size check skipped"
  only:
    - main
    - merge_requests
  needs:
    - build
  allow_failure: true

# SEO and HTML validation
seo_validation:
  stage: performance
  image: node:${NODE_VERSION}
  before_script:
    - npm ci --cache .npm --prefer-offline
    - npm install --save-dev html-validate || true
  script:
    - npx html-validate dist/**/*.html || echo "HTML validation skipped"
    - echo "SEO validation skipped (seo-checker not available)"
  artifacts:
    paths:
      - seo-report.json
    expire_in: 1 week
    when: always
  only:
    - main
    - merge_requests
  needs:
    - build
  allow_failure: true

# Cleanup job for old artifacts
cleanup:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Cleaning up old artifacts..."
  only:
    - schedules
  when: manual