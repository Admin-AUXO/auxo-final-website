# GitLab CI/CD Pipeline for Astro + Sanity Website
# Optimized for auxodata.com deployment

stages:
  - security
  - test
  - build
  - deploy
  - performance

variables:
  NODE_VERSION: "20.19.1"
  NPM_VERSION: "10.2.3"
  GIT_DEPTH: 10
  FF_USE_FASTZIP: "true"
  FF_DISABLE_UMASK_FOR_DOCKER_EXECUTOR: "true"

# Global cache configuration
cache:
  key:
    files:
      - package-lock.json
  paths:
    - .npm/
    - node_modules/
  policy: pull-push

# Security scanning
secret_detection:
  stage: security
  image:
    name: zricethezav/gitleaks:latest
    entrypoint: [""]
  before_script:
    - echo "Starting secret detection scan..."
  script:
    - |
      if [ -f .gitleaks.toml ]; then
        gitleaks detect --source . --verbose --redact --config .gitleaks.toml || true
      else
        gitleaks detect --source . --verbose --redact || true
      fi
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

# Dependency vulnerability scanning
dependency_scanning:
  stage: security
  image: node:${NODE_VERSION}
  before_script:
    - npm ci --cache .npm --prefer-offline --legacy-peer-deps
  script:
    - npm audit --audit-level high --omit=dev || true
    - npx audit-ci --config audit-ci.json || true
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop
  artifacts:
    when: always
    expire_in: 1 week

# License compliance scanning
license_scanning:
  stage: security
  image: node:${NODE_VERSION}
  before_script:
    - npm ci --cache .npm --prefer-offline --legacy-peer-deps
    - npm install --save-dev license-checker --legacy-peer-deps || true
  script:
    - npx license-checker --production --csv > licenses.csv || echo "license-checker not available"
    - npx license-checker --production --summary | tee license-summary.txt || echo "license-checker not available"
  artifacts:
    paths:
      - licenses.csv
      - license-summary.txt
    expire_in: 1 week
    when: always
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

# Linting and type checking
lint:
  stage: test
  image: node:${NODE_VERSION}
  before_script:
    - npm ci --cache .npm --prefer-offline --legacy-peer-deps
  script:
    - npm run lint
  artifacts:
    when: always
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop
  allow_failure: true

# Unit tests and integration tests
test:
  stage: test
  image: mcr.microsoft.com/playwright:v1.57.0-jammy
  before_script:
    - npm ci --cache .npm --prefer-offline --legacy-peer-deps
    - npx playwright install --with-deps
  script:
    - npm run test:ci
  artifacts:
    paths:
      - test-results/
      - playwright-report/
    reports:
      junit: test-results/junit.xml
    expire_in: 1 week
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'
  only:
    - merge_requests
    - main
    - develop
  allow_failure: true

# Build production assets
build:
  stage: build
  image: node:${NODE_VERSION}
  before_script:
    - npm ci --cache .npm --prefer-offline --legacy-peer-deps
  script:
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour
  only:
    - main
    - develop
    - merge_requests
  environment:
    name: production
    url: https://auxodata.com

# Deploy to GitLab Pages (only on main branch)
pages:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Deploying to GitLab Pages for auxodata.com..."
    - rm -rf public
    - mv dist public
    - ls -la public/
  artifacts:
    paths:
      - public/
    expire_in: 1 year
  only:
    - main
  needs:
    - build

# Performance monitoring with Lighthouse
performance:
  stage: performance
  image: node:${NODE_VERSION}
  before_script:
    - npm ci --cache .npm --prefer-offline --legacy-peer-deps
    - npm install --save-dev @lhci/cli --legacy-peer-deps || true
  script:
    - npx lhci autorun --config=lighthouserc.json || echo "Lighthouse CI not available"
  artifacts:
    paths:
      - .lighthouseci/
    expire_in: 1 week
    when: always
  only:
    - main
    - merge_requests
  needs:
    - build
  allow_failure: true

# Accessibility testing
accessibility:
  stage: performance
  image: node:${NODE_VERSION}
  before_script:
    - npm ci --cache .npm --prefer-offline --legacy-peer-deps
    - npm install --save-dev pa11y-ci --legacy-peer-deps || true
  script:
    - |
      if [ ! -d "dist" ]; then
        echo "No dist folder found, skipping accessibility tests"
        exit 0
      fi
      echo "Starting preview server for accessibility testing..."
      npm run preview > /tmp/preview.log 2>&1 &
      PREVIEW_PID=$!
      sleep 15
      if ! command -v curl > /dev/null 2>&1; then
        echo "curl not available, waiting additional time for server to start..."
        sleep 10
      else
        if ! curl -f http://localhost:4341/ > /dev/null 2>&1; then
          echo "Preview server failed to start, waiting longer..."
          sleep 10
        fi
      fi
      echo "Running Pa11y accessibility tests..."
      npx pa11y-ci --config=.pa11yci.json || echo "Pa11y CI completed with warnings"
      kill $PREVIEW_PID 2>/dev/null || true
      wait $PREVIEW_PID 2>/dev/null || true
  artifacts:
    paths:
      - accessibility-results.json
    expire_in: 1 week
    when: always
  only:
    - main
    - merge_requests
  needs:
    - build
  allow_failure: true

# Bundle size monitoring
bundle_size:
  stage: performance
  image: node:${NODE_VERSION}
  before_script:
    - npm ci --cache .npm --prefer-offline --legacy-peer-deps
  script:
    - |
      if [ -d "dist/_astro" ]; then
        echo "Checking bundle sizes..."
        find dist/_astro -name "*.js" -exec sh -c 'size=$(du -h "$1" | cut -f1); echo "JS: $1 - $size"' _ {} \;
        find dist/_astro -name "*.css" -exec sh -c 'size=$(du -h "$1" | cut -f1); echo "CSS: $1 - $size"' _ {} \;
      else
        echo "No dist folder found, skipping bundle size check"
      fi
  only:
    - main
    - merge_requests
  needs:
    - build
  allow_failure: true

# SEO and HTML validation
seo_validation:
  stage: performance
  image: node:${NODE_VERSION}
  before_script:
    - npm ci --cache .npm --prefer-offline --legacy-peer-deps
    - npm install --save-dev html-validate --legacy-peer-deps || true
  script:
    - |
      if [ -d "dist" ]; then
        echo "Running HTML validation..."
        find dist -name "*.html" -type f | head -20 | xargs npx html-validate --format json > seo-report.json 2>&1 || echo "HTML validation completed with warnings"
        if [ ! -s seo-report.json ]; then
          echo '{"valid": true, "messages": []}' > seo-report.json
        fi
      else
        echo "No dist folder found, skipping HTML validation"
        echo '{"valid": false, "error": "No dist folder found"}' > seo-report.json
      fi
    - echo "SEO validation completed"
  artifacts:
    paths:
      - seo-report.json
    expire_in: 1 week
    when: always
  only:
    - main
    - merge_requests
  needs:
    - build
  allow_failure: true

# Cleanup job for old artifacts
cleanup:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Cleaning up old artifacts..."
  only:
    - schedules
  when: manual
