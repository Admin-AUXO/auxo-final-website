---
import { Icon } from "astro-icon/components";
import Button from "@/components/ui/Button.astro";
import SectionContainer from "@/components/layouts/SectionContainer.astro";
import HighlightText from "@/components/ui/HighlightText.astro";
import type { HomepageContent } from "@/data/content/homepage";
import { createUrl } from "@/utils/url";
import { shouldOpenCalendly } from "@/utils/ctaRules";

interface Props {
  content: HomepageContent["finalCta"];
}

const { content } = Astro.props;
const subtitleParts = content.subtitle.split(" ");
const subtitleLine1 = subtitleParts.slice(0, 3).join(" ");
const subtitleLine2 = subtitleParts.slice(3).join(" ");
const shouldOpenCalendlyBtn = shouldOpenCalendly({
  text: content.ctaText,
  href: content.ctaHref,
  context: 'cta-section'
});
---

<SectionContainer
  id="final-cta"
  padding="normal"
  background="surface"
  class="relative flex items-center overflow-hidden final-cta-section section-divider-top"
>
  <div class="section-gradient-hero absolute inset-0 pointer-events-none z-0"></div>
  <div class="absolute inset-0 cta-pattern opacity-30 z-0"></div>

  <div class="grid-container relative z-content w-full">
    <div class="col-span-full max-w-4xl mx-auto w-full">
      <div
        class="cta-card text-center bg-theme-card backdrop-blur-xl border-2 border-accent-green/50 rounded-2xl shadow-2xl shadow-accent-green/20 p-6 sm:p-8 md:p-10 lg:p-12 xl:p-16 transition-all hover:shadow-accent-green/30 hover:border-accent-green/70"
        data-reveal="zoom-in"
        data-reveal-duration="800"
        data-reveal-easing="ease-out-cubic"
      >
        <h2
          class="text-h2 font-extrabold mb-6 sm:mb-8 lg:mb-10 text-theme-primary transition-colors leading-tight tracking-tight font-display"
          data-reveal="fade-down"
          data-reveal-delay="150"
          data-reveal-duration="600"
          data-reveal-easing="ease-out-cubic"
        >
          <HighlightText text={content.title} highlight="next step" highlightClass="text-accent-green font-black text-[1.05em]" />
        </h2>

        <div
          class="highlight-subtitle-container mb-6 sm:mb-8 lg:mb-10"
          data-reveal="zoom-in"
          data-reveal-delay="250"
          data-reveal-duration="700"
          data-reveal-easing="ease-out-cubic"
        >
          <h3
            class="text-h2 sm:text-h1 font-extrabold leading-tight tracking-tight highlight-cta-text font-display"
          >
            <span class="block"><HighlightText text={subtitleLine1} highlight="Book" highlightClass="text-accent-green font-black" /></span>
            <span class="block"><HighlightText text={subtitleLine2} highlight="call" highlightClass="text-accent-green font-black" /></span>
          </h3>
        </div>

        <p
          class="text-body-xl sm:text-[1.1875rem] lg:text-[1.25rem] text-theme-secondary mb-8 sm:mb-10 lg:mb-12 max-w-2xl mx-auto leading-relaxed transition-colors font-normal font-body"
          data-reveal="fade-up"
          data-reveal-delay="350"
          data-reveal-duration="600"
          data-reveal-easing="ease-out-cubic"
        >
          {content.body}
        </p>

        <div
          class="flex flex-col sm:flex-row gap-4 sm:gap-5 justify-center mb-6 sm:mb-8 lg:mb-10"
          data-reveal="zoom-in"
          data-reveal-delay="450"
          data-reveal-duration="600"
          data-reveal-easing="ease-out-cubic"
        >
          <Button
            variant="primary"
            size="lg"
            href={shouldOpenCalendlyBtn ? undefined : createUrl(content.ctaHref)}
            googleCalendar={shouldOpenCalendlyBtn}
            class="w-full sm:w-auto font-bold shadow-lg shadow-accent-green/20 justify-center hover:shadow-xl hover:shadow-accent-green/30 hover:-translate-y-0.5 transition-all min-h-[44px] cta-button flex-nowrap"
          >
            <span class="whitespace-nowrap">{shouldOpenCalendlyBtn ? "Book a Consultation" : content.ctaText}</span>
            <Icon name="mdi:arrow-right" class="w-4 h-4 flex-shrink-0" />
          </Button>
        </div>

        <p
          class="text-body-base text-theme-secondary opacity-80 italic transition-colors font-normal font-body"
          data-reveal="fade-up"
          data-reveal-delay="550"
          data-reveal-duration="600"
          data-reveal-easing="ease-out-cubic"
        >
          {content.reassuranceLine}
        </p>
      </div>
    </div>
  </div>
</SectionContainer>


