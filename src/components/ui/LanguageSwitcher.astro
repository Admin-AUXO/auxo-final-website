---
import { Icon } from "astro-icon/components";
import { getLanguageFromUrl } from "@/i18n";

interface Props {
  isMobile?: boolean;
}

const { isMobile = false } = Astro.props;
const currentLang = getLanguageFromUrl(Astro.url);
const currentPath = Astro.url.pathname;

const isArabic = currentLang === 'ar';
const targetPath = isArabic 
  ? currentPath.replace(/^\/ar/, '') || '/'
  : `/ar${currentPath}`;

const languages = [
  { code: 'en', label: 'English', flag: 'ðŸ‡¬ðŸ‡§', path: isArabic ? targetPath : currentPath },
  { code: 'ar', label: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', flag: 'ðŸ‡¦ðŸ‡ª', path: isArabic ? currentPath : targetPath },
];
---

{isMobile ? (
  <a
    href={targetPath}
    class="lang-switch-mobile flex items-center justify-center w-12 h-6 rounded-full bg-theme-surface border border-theme-surface text-xs font-medium transition-all hover:border-accent-green hover:text-accent-green"
    aria-label={`Switch to ${isArabic ? 'English' : 'Arabic'}`}
  >
    {isArabic ? 'EN' : 'Ø¹'}
  </a>
) : (
  <div class="language-switcher relative">
    <button
      type="button"
      class="lang-btn flex items-center gap-2 px-3 py-2 h-10 rounded-lg bg-theme-surface border border-theme-surface text-theme-secondary hover:text-accent-green hover:bg-accent-green/10 hover:border-accent-green/30 transition-all duration-fast touch-target"
      aria-label="Change language"
      aria-haspopup="true"
      aria-expanded="false"
      data-lang-dropdown-trigger
    >
      <span class="text-base">{languages.find(l => l.code === currentLang)?.flag}</span>
      <span class="text-sm font-medium uppercase">{currentLang}</span>
      <Icon name="mdi:chevron-down" class="w-4 h-4 transition-transform duration-fast" data-chevron />
    </button>

    <div
      class="lang-dropdown absolute top-full right-0 mt-2 w-44 py-2 bg-theme-card rounded-lg border border-theme-surface shadow-lg opacity-0 invisible pointer-events-none transition-all duration-fast origin-top scale-95"
      role="menu"
      data-lang-dropdown
    >
      {languages.map((lang) => (
        <a
          href={lang.path}
          class:list={[
            "lang-option flex items-center gap-3 px-4 py-2.5 text-sm transition-colors",
            lang.code === currentLang 
              ? "text-accent-green bg-accent-green/10 font-medium" 
              : "text-theme-secondary hover:text-theme-primary hover:bg-theme-surface"
          ]}
          role="menuitem"
          data-lang={lang.code}
        >
          <span class="text-lg">{lang.flag}</span>
          <span>{lang.label}</span>
          {lang.code === currentLang && (
            <Icon name="mdi:check-bold" class="w-4 h-4 ml-auto text-accent-green" />
          )}
        </a>
      ))}
    </div>
  </div>
)}

<style>
  .language-switcher:hover .lang-dropdown,
  .language-switcher:focus-within .lang-dropdown {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
    transform: scale(1);
  }

  .language-switcher:hover [data-chevron],
  .language-switcher:focus-within [data-chevron] {
    transform: rotate(180deg);
  }

  .lang-option {
    cursor: pointer;
  }

  .lang-switch-mobile {
    flex-shrink: 0;
  }

  @media (max-width: 1023px) {
    .lang-dropdown {
      right: 0;
      left: auto;
    }
  }
</style>

<script>
  function initLanguageSwitcher() {
    const triggers = document.querySelectorAll('[data-lang-dropdown-trigger]');
    
    triggers.forEach(trigger => {
      const dropdown = trigger.nextElementSibling as HTMLElement;
      if (!dropdown) return;

      trigger.addEventListener('click', (e) => {
        e.stopPropagation();
        const isOpen = dropdown.classList.contains('opacity-100');
        
        if (!isOpen) {
          trigger.setAttribute('aria-expanded', 'true');
        } else {
          trigger.setAttribute('aria-expanded', 'false');
        }
      });

      document.addEventListener('click', () => {
        trigger.setAttribute('aria-expanded', 'false');
      });
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initLanguageSwitcher);
  } else {
    initLanguageSwitcher();
  }

  document.addEventListener('astro:page-load', initLanguageSwitcher);
</script>
