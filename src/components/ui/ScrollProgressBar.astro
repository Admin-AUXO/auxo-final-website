---
import '../../styles/components/scroll-progress.css';
---

<div id="scroll-progress-bar" class="fixed top-0 left-0 right-0 w-full bg-transparent pointer-events-none h-[var(--scroll-progress-height-mobile)] sm:h-[var(--scroll-progress-height)]" aria-hidden="true">
  <div class="scroll-progress-bar-fill"></div>
</div>

<script>
  function initScrollProgressBar(): void {
    const progressBar = document.getElementById('scroll-progress-bar');
    const progressFill = progressBar?.querySelector('.scroll-progress-bar-fill') as HTMLElement;

    if (!progressBar || !progressFill) return;

    let lenis: any = window.lenis;
    let rafId: number | null = null;
    let lenisCheckInterval: ReturnType<typeof setInterval> | null = null;
    
    function checkLenis() {
      if (!lenis && window.lenis) {
        lenis = window.lenis;
      }
    }

    function updateProgress(): void {
      const windowHeight = window.innerHeight;
      const documentHeight = Math.max(
        document.body.scrollHeight,
        document.body.offsetHeight,
        document.documentElement.clientHeight,
        document.documentElement.scrollHeight,
        document.documentElement.offsetHeight
      );
      
      let scrollTop = 0;
      if (lenis && typeof lenis.scroll === 'number') {
        scrollTop = lenis.scroll;
      } else if (window.lenis && typeof window.lenis.scroll === 'number') {
        scrollTop = window.lenis.scroll;
      } else {
        scrollTop = window.scrollY || window.pageYOffset || document.documentElement.scrollTop || 0;
      }

      const totalScrollableHeight = documentHeight - windowHeight;
      const scrollProgress = totalScrollableHeight > 0
        ? Math.min(100, Math.max(0, (scrollTop / totalScrollableHeight) * 100))
        : 0;

      progressFill.style.setProperty('--scroll-progress-width', `${scrollProgress}%`);
    }

    function throttledUpdate(): void {
      if (rafId !== null) return;
      rafId = requestAnimationFrame(() => {
        updateProgress();
        rafId = null;
      });
    }

    function setupLenisListener(): boolean {
      checkLenis();
      if (lenis && typeof lenis.on === 'function') {
        lenis.on('scroll', throttledUpdate);
        return true;
      }
      return false;
    }

    if (!setupLenisListener()) {
      window.addEventListener('lenis:init', () => {
        lenis = window.lenis;
        setupLenisListener();
      }, { once: true });
    }

    window.addEventListener('scroll', throttledUpdate, { passive: true });

    window.addEventListener('resize', () => {
      checkLenis();
      setTimeout(updateProgress, 100);
    }, { passive: true });
    
    lenisCheckInterval = setInterval(() => {
      if (!lenis && window.lenis) {
        lenis = window.lenis;
        setupLenisListener();
        if (lenisCheckInterval) {
          clearInterval(lenisCheckInterval);
          lenisCheckInterval = null;
        }
      }
    }, 100);
    
    setTimeout(() => {
      if (lenisCheckInterval) {
        clearInterval(lenisCheckInterval);
        lenisCheckInterval = null;
      }
    }, 5000);

    updateProgress();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initScrollProgressBar);
  } else {
    initScrollProgressBar();
  }
</script>


